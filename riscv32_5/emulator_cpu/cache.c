#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>



uint8_t mem[256000];

unsigned char rawData[246] = {
    0x6F, 0x00, 0xC0, 0x08, 0x13, 0x01, 0x01, 0xFE, 0x23, 0x2E, 0x81, 0x00,
    0x13, 0x04, 0x01, 0x02, 0x93, 0x07, 0x05, 0x00, 0xA3, 0x07, 0xF4, 0xFE,
    0xB7, 0xA7, 0x0F, 0x00, 0x93, 0x87, 0x27, 0x00, 0x03, 0x47, 0xF4, 0xFE,
    0x23, 0x80, 0xE7, 0x00, 0x13, 0x00, 0x00, 0x00, 0x03, 0x24, 0xC1, 0x01,
    0x13, 0x01, 0x01, 0x02, 0x67, 0x80, 0x00, 0x00, 0x13, 0x01, 0x01, 0xFE,
    0x23, 0x2E, 0x11, 0x00, 0x23, 0x2C, 0x81, 0x00, 0x13, 0x04, 0x01, 0x02,
    0x23, 0x26, 0xA4, 0xFE, 0x6F, 0x00, 0x00, 0x02, 0x83, 0x27, 0xC4, 0xFE,
    0x13, 0x87, 0x17, 0x00, 0x23, 0x26, 0xE4, 0xFE, 0x83, 0xC7, 0x07, 0x00,
    0x13, 0x85, 0x07, 0x00, 0x97, 0x00, 0x00, 0x00, 0xE7, 0x80, 0x00, 0xFA,
    0x83, 0x27, 0xC4, 0xFE, 0x83, 0xC7, 0x07, 0x00, 0xE3, 0x9E, 0x07, 0xFC,
    0x13, 0x00, 0x00, 0x00, 0x83, 0x20, 0xC1, 0x01, 0x03, 0x24, 0x81, 0x01,
    0x13, 0x01, 0x01, 0x02, 0x67, 0x80, 0x00, 0x00, 0x13, 0x01, 0x01, 0xFE,
    0x23, 0x2E, 0x11, 0x00, 0x23, 0x2C, 0x81, 0x00, 0x13, 0x04, 0x01, 0x02,
    0x97, 0x07, 0x00, 0x00, 0x93, 0x87, 0x07, 0x05, 0x23, 0x24, 0xF4, 0xFE,
    0x23, 0x26, 0x04, 0xFE, 0x6F, 0x00, 0xC0, 0x01, 0x03, 0x25, 0x84, 0xFE,
    0x97, 0x00, 0x00, 0x00, 0xE7, 0x80, 0x40, 0xF8, 0x83, 0x27, 0xC4, 0xFE,
    0x93, 0x87, 0x17, 0x00, 0x23, 0x26, 0xF4, 0xFE, 0x03, 0x27, 0xC4, 0xFE,
    0x93, 0x07, 0x90, 0x00, 0xE3, 0xD0, 0xE7, 0xFE, 0x13, 0x00, 0x00, 0x00,
    0x83, 0x20, 0xC1, 0x01, 0x03, 0x24, 0x81, 0x01, 0x13, 0x01, 0x01, 0x02,
    0x67, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x63, 0x70, 0x75, 0x20,
    0x74, 0x65, 0x73, 0x74, 0x0A, 0x00
};

typedef uint8_t byte;
typedef uint32_t word;


#define BLOCK 256
#define N 0xf

word cachePage[16]; // byte -> word
byte cacheRAM[16][256]; // no change


/*******************************************/
void write(uint32_t addr,uint8_t data){
    byte a = (addr & 0x00FFFF00) >> 8;        // a = 0x5612
    byte p = a >> 4;                          // p = 0x0561
    byte n = a & 0x0F;                        // n = 0x0002
    byte r = (addr & 0x00FF);                 // r = 0x34
 
    if(cachePage[n]==p){
        cacheRAM[n][r]=data;
        mem[addr]=data;
    }else{
          
        cacheRAM[n][r]=data;
        mem[addr]=data;
        memcpy(cacheRAM[n],&mem[(addr & 0xFFFFFF00)],BLOCK);

        cachePage[n]=p;
    }
}

byte read(uint32_t addr){
   byte a = (addr & 0x00FFFF00) >> 8;        // a = 0x5612
   byte p = a >> 4;                          // p = 0x0561
   byte n = a & 0x0F;                        // n = 0x0002
   byte r = (addr & 0x00FF);                 // r = 0x34

    if(cachePage[n]==p){
        return cacheRAM[n][r];
    }else{
        //memcpy(&mem[addr],cacheRAM[n],BLOCK);
        memcpy(cacheRAM[n],&mem[(addr & 0xFFFFFF00)],BLOCK);
        cachePage[n]=p;
        return cacheRAM[n][r];
    }
}
/*******************************************/
 
/*
void calc(uint32_t addr){//0xfffff .. 0x1f400
    uint16_t block = addr / BLOCK;
    uint16_t r = addr % BLOCK;
    printf("block: %i , r: %i\n",block,r);
}

uint16_t store=0xffff;
uint8_t RAM[BLOCK];


void write2(uint32_t addr,uint8_t data){
    uint16_t block = addr / BLOCK;
    uint16_t r = addr % BLOCK;

    if(block==store){
        RAM[r]=data;
        mem[addr]=data;
    }else{
        RAM[r]=data;
        memcpy(&mem[addr],RAM,BLOCK);
        memcpy(RAM,&mem[addr],BLOCK);
        store=block;
    }
}

byte read2(uint32_t addr){
    uint16_t block = addr / BLOCK;
    uint16_t r = addr % BLOCK;

   if(block==store){
        return RAM[r];
    }else{
        //memcpy(&mem[addr],cacheRAM[n],BLOCK);
        memcpy(RAM,&mem[addr],BLOCK);
        store=block;
        return RAM[r];
    }
}
*/


int main(int argc, char const *argv[])
{

     
    
    uint32_t j=0;
    #define offset 40000
    #define end 120000
 
    for (int i = 0; i < 16; ++i)
    {
        cachePage[i]=0xff;
    }
    uint8_t *buff=(uint8_t*)calloc(200000,sizeof(uint8_t));
    uint8_t *buff2=(uint8_t*)calloc(200000,sizeof(uint8_t));

    
    for (uint32_t i = offset; i < offset + end; ++i)
    {
         uint8_t c = rand() % 255;
         buff[i-offset]=c;
         buff2[i-offset]=c;
         write(i,c);
    }

 

    for (uint32_t i = offset; i < offset  + end; ++i)
    {
         uint8_t c = read(i);
         if(buff2[i-offset]!=buff[i-offset]){
            printf("error buffer: %i,%i,%i\n",i,buff[i-offset],buff2[i-offset]);
            break;
         }
         if(c!=buff[i-offset]){
            printf("error %i,%i,%i\n",i,c,buff[i-offset]);
            break;
         }
    
    }
    free(buff);
    free(buff2);

 
	return 0;
}